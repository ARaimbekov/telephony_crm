{% extends "base.html" %}
{% load tailwind_filters %}
{% load crispy_forms_tags %}
{% load static %}


{% block content %}
<div class="max-w-lg mx-auto">
    <a class="hover:text-blue-500" href="{% url 'leads:lead-list' %}">Вернуться к таблице</a>
    <div class="py-5 border-t border-gray-200">
        <h1 class="text-4xl text-gray-800">Создание новой позиции</h1>
    </div>
    <form method="post" class="mt-25">
        {% csrf_token %}
        {{ form|crispy }}



        <button type='submit' class="w-full text-white bg-blue-500 hover:bg-blue-600 px-3 py-2 rounded-md">
            Готово
        </button>
    </form>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    let atc_field = document.getElementById("div_id_atc")
    let number_field = document.querySelector("div.relative select[name='phone_number']")
    atc_field.addEventListener("change", getAtcId)


    function getAtcId(e) {
        let atc_id = e.target.value


        const data = { id: atc_id };

        let url = " {% url 'leads:lead-phone' %} "

        fetch(url, {
            method: 'POST', // or 'PUT'
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data),
        })
            .then((response) => response.json())

            .then((data) => {
                console.log('Success:', data);

                if (data.length != 0) {
                    number_field.innerHTML = `<option value="${data[0]["id"]}" id="number-id-field">${data[0]["name"]}</option>`


                    for (let i = 1; i < data.length; i++) {
                        number_field.innerHTML += `<option value="${data[i]["id"]}" id="number-id-field">${data[i]["name"]}</option>`
                    }

                } else {
                    number_field.innerHTML = '<option value="" id="number-id-field">Нет свободных номером</option>'

                }

            })
            .catch((error) => {
                console.error('Error:', error);
            });

    }
</script>




{% endblock content %}